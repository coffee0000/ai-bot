開発（かいはつ）タスク清単（せいたん）

（厳密（げんみつ）な層（そう）分（わ）け＋実行（じっこう）順（じゅん））

第（だい）0層（そう）：工程（こうてい）ベースライン層（そう）
	1.	プロジェクト骨格（こっかく）を確立（かくりつ）：aiohttp＋Bot Framework SDK の最小（さいしょう）構成（こうせい）を作成（さくせい）し、ローカル起動（きどう）できる状態（じょうたい）にする。
	2.	設定（せってい）体系（たいけい）を整備（せいび）：.env／環境（かんきょう）変数（へんすう）一覧（いちらん）を定義（ていぎ）し、起動（きどう）時（じ）に読込（よみこ）む。
	3.	ログ体系（たいけい）を整備（せいび）：ログ形式（けいしき）を統一（とういつ）し、少（すく）なくとも request_id／session_id／status を出力（しゅつりょく）する。

⸻

第（だい）1層（そう）：接続（せつぞく）層（そう）（HTTP入口（いりぐち）層（そう）／aiohttp）
	4.	メッセージ入口（いりぐち）を実装（じっそう）：POST /api/messages を実装（じっそう）し、受信（じゅしん）データを Bot Framework Adapter に委譲（いじょう）する。
	5.	ライフサイクル処理（しょり）を実装（じっそう）：起動（きどう）時（じ）に資源（しげん）（Cosmos/LLM/権限（けんげん）クライアント）を初期化（しょきか）し、終了（しゅうりょう）時（じ）に解放（かいほう）する。
	6.	ヘルスチェックを実装（じっそう）：GET /health を用意（ようい）し、ローカル／CI の疎通（そつう）確認（かくにん）に使（つか）う。

⸻

第（だい）2層（そう）：適合（てきごう）層（そう）（Bot Framework 適合層（てきごうそう））
	7.	Adapter 初期化（しょきか）を実装（じっそう）：AppId/AppPassword を設定（せってい）し、ローカル開発（かいはつ）用（よう）に切替（きりかえ）可能（かのう）なフラグを用意（ようい）する。
	8.	Activity 受渡（うけわた）しを確立（かくりつ）：adapter.process_activity(...) から bot.on_turn(...) に到達（とうたつ）する経路（けいろ）を成立（せいりつ）させる。
	9.	適合層（てきごうそう）の例外（れいがい）処理（しょり）を整備（せいび）：SDK／解析（かいせき）例外（れいがい）時（じ）に HTTP 応答（おうとう）とログ出力（しゅつりょく）を統一（とういつ）する。

⸻

第（だい）3層（そう）：編成（へんせい）層（そう）（Bot編成層（へんせいそう）／ActivityHandler）
	10.	主編成（しゅへんせい）入口（いりぐち）を実装（じっそう）：on_message_activity() を実装（じっそう）し、手順（てじゅん）のみを定義（ていぎ）して詳細（しょうさい）実装（じっそう）を持（も）たない。
	11.	personal 限定（げんてい）分岐（ぶんき）を実装（じっそう）：personal 以外（いがい）は固定（こてい）メッセージで拒否（きょひ）し、監査（かんさ）を記録（きろく）する。
	12.	権限（けんげん）分岐（ぶんき）を実装（じっそう）：無権限（むけんげん）は固定（こてい）メッセージで拒否（きょひ）し、監査（かんさ）を記録（きろく）する。
	13.	並行（へいこう）抑止（よくし）分岐（ぶんき）を実装（じっそう）：同一（どういつ）session が「待機中（たいきちゅう）」なら固定（こてい）メッセージで返（かえ）し、監査（かんさ）を記録（きろく）する。
	14.	会話（かいわ）読書（どくしょ）き編成（へんせい）を実装（じっそう）：user 追加（ついか）→履歴（りれき）読込（よみこ）み→assistant 追加（ついか）の順序（じゅんじょ）を固定（こてい）する。
	15.	LLM 呼出（よびだ）し編成（へんせい）を実装（じっそう）：LLM サービスを呼（よ）び、返却（へんきゃく）テキストを加工（かこう）せず返（かえ）す。
	16.	finally 保証（ほしょう）を実装（じっそう）：成功（せいこう）／失敗（しっぱい）に関（かか）わらずロック解除（かいじょ）と監査（かんさ）記録（きろく）を必（かなら）ず実行（じっこう）する。

⸻

第（だい）4層（そう）：業務（ぎょうむ）サービス層（そう）（Services）

4.1 規則（きそく）サービス（Policy Service）
	17.	会話（かいわ）種別（しゅべつ）判定（はんてい）サービスを実装（じっそう）：personal 判定（はんてい）のみを責務（せきむ）として実装（じっそう）する。

4.2 権限（けんげん）サービス（Permission Service）
	18.	権限（けんげん）サービスのインタフェースを実装（じっそう）：is_allowed(user_id) を提供（ていきょう）し、Graph 未設定（みせってい）時（じ）はローカル用（よう）に許可（きょか）とする。
	19.	Graph 呼出（よびだ）し版（ばん）を実装（じっそう）：設定（せってい）完了（かんりょう）時（じ）に安全（あんぜん）グループ照会（しょうかい）を有効化（ゆうこうか）し、失敗（しっぱい）時（じ）の扱（あつか）いを定義（ていぎ）する。

4.3 会話（かいわ）サービス（Session Service）
	20.	会話（かいわ）データモデルを定義（ていぎ）：messages 構造（こうぞう）、最大（さいだい）保持（ほじ）件数（けんすう）、裁剪（さいせん）方針（ほうしん）を決定（けってい）する。
	21.	会話（かいわ）入出力（にゅうしゅつりょく）インタフェースを実装（じっそう）：load / append_user / append_assistant を提供（ていきょう）し、先（まず）はメモリ保存（ほぞん）で成立（せいりつ）させる。

4.4 並行（へいこう）制御（せいぎょ）サービス（Waiting Gate）
	22.	待機（たいき）状態（じょうたい）遷移（せんい）を定義（ていぎ）：acquire／release 規則（きそく）と失敗（しっぱい）時（じ）の戻（もど）しを定義（ていぎ）する。
	23.	単一（たんいつ）プロセス版（ばん）を実装（じっそう）：ローカルでは asyncio.Lock により排他（はい他）を成立（せいりつ）させる。
	24.	将来（しょうらい）移行（いこう）方針（ほうしん）を用意（ようい）：Cosmos の waiting フィールド書込（かきこ）みを前提（ぜんてい）に拡張（かくちょう）可能（かのう）な設計（せっけい）とする。

4.5 LLM サービス（LangChain + Azure OpenAI）
	25.	LLM サービスインタフェースを実装（じっそう）：generate(history, user_text) を提供（ていきょう）し、AOAI 未設定（みせってい）時（じ）は Mock 応答（おうとう）を返（かえ）す。
	26.	AOAI 呼出（よびだ）し版（ばん）を実装（じっそう）：設定（せってい）完了（かんりょう）時（じ）に LangChain 経由（けいゆ）で Azure OpenAI を呼（よ）び出（だ）す。
	27.	例外（れいがい）正規化（せいきか）を実装（じっそう）：拒否（きょひ）／制限（せいげん）／タイムアウトを分類（ぶんるい）し、編成層（へんせいそう）に返（かえ）す。

4.6 監査（かんさ）サービス（Audit Service）
	28.	監査（かんさ）イベントモデルを定義（ていぎ）：必須（ひっす）項目（こうもく）（ts／user／session／status／latency／error_type）を確定（かくてい）する。
	29.	監査（かんさ）記録（きろく）インタフェースを実装（じっそう）：成功（せいこう）／拒否（きょひ）／待機（たいき）／無権限（むけんげん）／例外（れいがい）をすべて記録（きろく）する。

4.7 エラー分類（ぶんるい）サービス
	30.	エラー分類表（ぶんるいひょう）を定義（ていぎ）：拒否（きょひ）／制限（せいげん）／タイムアウト／その他（そのた）。
	31.	ユーザー提示文（ていじぶん）を定義（ていぎ）：分類（ぶんるい）ごとの固定（こてい）メッセージを確定（かくてい）する。

⸻

第（だい）5層（そう）：データアクセス層（そう）（Repository／Cosmos）
	32.	メモリ保存（ほぞん）版（ばん）を実装（じっそう）：sessions＋audit をローカルで成立（せいりつ）させる。
	33.	Cosmos クライアント初期化（しょきか）を実装（じっそう）：設定（せってい）完了（かんりょう）時（じ）のみ Cosmos を有効化（ゆうこうか）する。
	34.	Cosmos 会話（かいわ）リポジトリを実装（じっそう）：session 読書（どくしょ）きとメッセージ追加（ついか）を提供（ていきょう）する。
	35.	Cosmos 監査（かんさ）リポジトリを実装（じっそう）：audit の append-only 書込（かきこ）みを提供（ていきょう）する。

⸻

第（だい）6層（そう）：テスト層（そう）
	36.	単体（たんたい）テストを整備（せいび）：policy／lock／error 分類（ぶんるい）の単体（たんたい）を作成（さくせい）する。
	37.	結合（けつごう）テストを整備（せいび）：編成層（へんせいそう）＋各サービスを Mock で接続（せつぞく）して主要（しゅよう）分岐（ぶんき）を確認（かくにん）する。
	38.	疎通（そつう）テストを整備（せいび）：Emulator で「受信（じゅしん）→生成（せいせい）→保存（ほぞん）→返信（へんしん）→監査（かんさ）」の一連（いちれん）を確認（かくにん）する。

⸻
